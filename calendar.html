<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Shepherd Calendar</title>
<link rel="stylesheet" href="calendar.css">
<style> 
@import url('https://fonts.googleapis.com/css2?family=Borel&display=swap');
</style>
</head>
<body>

<!-- Header -->
<header>
  <ul>
    <li><div class="nav-wrapper"><a href="board.html" >Board</a></div></li>
    <li><div class="nav-wrapper"><a href="calendar.html" >Calendar</a></div></li>
    <li><div class="nav-wrapper"><a href="map.html" >Map</a></div></li>
  </ul>
</header>

<!-- Main Content -->
<div id="main-content">
    <div id="calendar-container" style="min-width: 700px;">
        <div id="controls-box">
            <div id="calendar-controls">
                <label for="month-select">Month:</label>
                <select id="month-select"></select>
                <label for="year-select">Year:</label>
                <select id="year-select"></select>
            </div>
        </div>
        <div id="calendar"></div>
    </div>

    <!-- Availability Button -->
    <div id="availability-button-container">
      <button id="availabilityBtn">Enter Your Availability</button>
    </div>

    <div id="sidebar">
        <div id="sidebar-header">
            <h2 id="sidebar-title">Day Details</h2>
            <button id="close-sidebar">Ã—</button>
        </div>
        <div id="sidebar-content">
            <p>Select a day to view or add plans.</p>
        </div>
    </div>
</div>

<!-- Footer -->
<footer>
  <div>
      <p>Shepherd &copy; 2025 - MinisterMe</p>
      <p><a href="#" style="color: white;">Report A Problem</a></p>
      <p><a href="#" style="color: white;">Contact Info</a></p>
      <p>Socials</p>
  </div>
  <div id="social-links">
      <a href="https://www.facebook.com/" target="_blank" class="social-link">
          <img id="face" src="images/Facebook_Logo_2023.png" alt="Facebook Logo">
          <span>Facebook</span>
      </a>
      <a href="https://www.instagram.com" target="_blank" class="social-link">
          <img id="insta" src="images/instagram-logo-instagram-icon-transparent-free-png.webp" alt="Instagram Logo">
          <span>Instagram</span>
      </a>
      <a href="https://www.x.com" target="_blank" class="social-link">
          <img id="x" src="images/pngimg.com - x_logo_PNG17.png" alt="X logo">
          <span>X</span>
      </a>
  </div>
</footer>

<!-- Availability Modal -->
<div id="availabilityModal" class="modal-overlay">
  <div class="modal-content">
      <span class="close-btn" id="closeAvailability">&times;</span>
      <h2>Enter Your Availability</h2>
      <label for="nameInput">Your Name:</label><br/>
      <input type="text" id="nameInput" placeholder="Enter your name" style="width: 80%; margin-bottom:10px; padding:5px;"><br/>
      <label for="dateInput">Date:</label><br/>
      <input type="date" id="dateInput" style="width: 80%; margin-bottom:10px; padding:5px;"><br/>
      <button id="saveAvailabilityBtn" style="margin-top:10px; padding: 5px 10px;">Save Availability</button>
      <div id="availabilityMessage" style="color:green; margin-top:5px;"></div>
  </div>
</div>

<script>


/* Helpers */
function pad(n){ return String(n).padStart(2,'0'); }

const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

const calendarEl = document.getElementById('calendar');
const sidebar = document.getElementById('sidebar');
const sidebarTitle = document.getElementById('sidebar-title');
const sidebarContent = document.getElementById('sidebar-content');
const monthSelect = document.getElementById('month-select');
const yearSelect = document.getElementById('year-select');
const closeBtn = document.getElementById('close-sidebar');

const availabilityBtn = document.getElementById('availabilityBtn');
const availabilityModal = document.getElementById('availabilityModal');
const closeAvailability = document.getElementById('closeAvailability');
const saveAvailabilityBtn = document.getElementById('saveAvailabilityBtn');
const nameInput = document.getElementById('nameInput');
const dateInput = document.getElementById('dateInput');
const availabilityMessage = document.getElementById('availabilityMessage');

/* Close sidebar */
closeBtn.addEventListener('click', () => { sidebar.style.display = 'none'; });

/* Populate months */
months.forEach((m,i)=>{
  const option = document.createElement('option');
  option.value = i;
  option.textContent = m;
  monthSelect.appendChild(option);
});

/* Populate years */
for(let y=2020; y<=2030; y++){
  const option = document.createElement('option');
  option.value = y;
  option.textContent = y;
  yearSelect.appendChild(option);
}

/* Set current */
const now = new Date();
monthSelect.value = now.getMonth();
yearSelect.value = now.getFullYear();

/* Global renderCalendar */
function renderCalendar(year, month){
    const availability = JSON.parse(localStorage.getItem("availability")) || {};
    const today = new Date();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    let html = `<h3>${months[month]} ${year}</h3>`;

    for (let i = 0; i < firstDay.getDay(); i++) {
        html += `<div class="day placeholder"></div>`;
    }

    for (let d = 1; d <= lastDay.getDate(); d++) {
        const dateKey = `${year}-${pad(month+1)}-${pad(d)}`;
        const names = availability[dateKey] || [];
        const isToday = d === today.getDate() && month === today.getMonth() && year === today.getFullYear();

        html += `
            <div class="day ${isToday ? 'today' : ''}" onclick="selectDate(${year}, ${month}, ${d})" data-date="${dateKey}">
                <div style="font-size:16px; font-weight:600;">${d}</div>
                ${names.length > 0 ? `<div class="avail-count">${names.length} AVAILABLE</div>` : ''}
            </div>
        `;
    }

    calendarEl.innerHTML = html;
}

/* selectDate function */
window.selectDate = function(year, month, day){
    sidebar.style.display = 'block';
    const dateKey = `${year}-${pad(month+1)}-${pad(day)}`;
    sidebarTitle.textContent = `Plan for ${dateKey}`;

    const plan = localStorage.getItem("plan-" + dateKey) || "";
    const availability = JSON.parse(localStorage.getItem("availability")) || {};
    const names = availability[dateKey] || [];

    let availHtml = '';
    if(names.length === 0){
        availHtml = `<p>No one has marked availability for this date.</p>`;
    } else {
        availHtml = `<div id="availability-list">`;
        names.forEach((n, idx) => {
            availHtml += `<div class="avail-list-item"><span class="avail-name">${escapeHtml(n)}</span><div><button class="remove-availability-btn" data-date="${dateKey}" data-name="${escapeHtmlAttr(n)}">Remove</button></div></div>`;
        });
        availHtml += `</div>`;
    }

    sidebarContent.innerHTML = `
        <p><strong>Saved plan for ${dateKey}:</strong></p>
        <textarea id="plan-textarea" placeholder="Enter your plan here...">${escapeHtml(plan)}</textarea>
        <div>
            <button class="save-btn" id="sidebar-save">Save</button>
            <button class="save-close-btn" id="sidebar-save-close">Save & Close</button>
            <div id="saved-message" style="color:green; margin-top:5px;"></div>
        </div>
        <hr style="margin-top:12px;"/>
        <div>
            <p><strong>Availability for ${dateKey}:</strong></p>
            ${availHtml}
        </div>
    `;

    const textarea = document.getElementById('plan-textarea');
    const savedMsg = document.getElementById('saved-message');
    document.getElementById('sidebar-save').onclick = function(){
        localStorage.setItem("plan-" + dateKey, textarea.value);
        savedMsg.textContent = "Saved!";
        setTimeout(()=> savedMsg.textContent = '', 1500);
    };
    document.getElementById('sidebar-save-close').onclick = function(){
        localStorage.setItem("plan-" + dateKey, textarea.value);
        sidebar.style.display = 'none';
    };

    const availabilityList = sidebarContent.querySelector('#availability-list');
    if(availabilityList){
        availabilityList.addEventListener('click', function(e){
            const btn = e.target.closest('.remove-availability-btn');
            if(!btn) return;
            const dt = btn.getAttribute('data-date');
            const nm = btn.getAttribute('data-name');
            const nameDecoded = htmlAttrDecode(nm);
            removeAvailability(dt, nameDecoded);
            window.selectDate(year, month, day);
            renderCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value));
        });
    }
};

function removeAvailability(dateKey, name){
    const availability = JSON.parse(localStorage.getItem("availability")) || {};
    if(!availability[dateKey]) return;
    availability[dateKey] = availability[dateKey].filter(n => n !== name);
    if(availability[dateKey].length === 0) delete availability[dateKey];
    localStorage.setItem("availability", JSON.stringify(availability));
}

/* Availability modal open/close */
availabilityBtn.addEventListener('click', () => {
    availabilityModal.style.display = 'flex';
});
closeAvailability.addEventListener('click', () => {
    availabilityModal.style.display = 'none';
    availabilityMessage.textContent = '';
});
availabilityModal.addEventListener('click', (e) => {
    if(e.target === availabilityModal) availabilityModal.style.display = 'none';
});

/* Save availability */
saveAvailabilityBtn.addEventListener('click', () => {
    const name = nameInput.value.trim();
    const date = dateInput.value;
    if(!name || !date){
        availabilityMessage.style.color = 'red';
        availabilityMessage.textContent = 'Please fill in both fields!';
        return;
    }
    const availability = JSON.parse(localStorage.getItem("availability")) || {};
    if(!availability[date]) availability[date] = [];
    if(!availability[date].includes(name)) availability[date].push(name);
    localStorage.setItem("availability", JSON.stringify(availability));
    availabilityMessage.style.color = 'green';
    availabilityMessage.textContent = 'Saved!';
    nameInput.value = '';
    dateInput.value = '';
    renderCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value));
});

/* Month/year change */
monthSelect.addEventListener('change', ()=> renderCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value)));
yearSelect.addEventListener('change', ()=> renderCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value)));

/* Initial render */
renderCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value));

/* Escape functions */
function escapeHtml(str) {
    if(!str) return '';
    return str.replace(/&/g, "&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function escapeHtmlAttr(str){
    return str.replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function htmlAttrDecode(str){
    const txt = document.createElement('textarea');
    txt.innerHTML = str;
    return txt.value;
}
</script>
</body>
</html>
